# 14.1 イントロダクション
この項では、C++17 での実際のマルチスレッドプログラミングの解説の前に、**スレッド**とは何なのか、またそれらと関連する他の概念やそれとの違いは何なのか、それが何故必要なのか、更にシングルスレッドプログラミングでは考慮する必要のなかった**競合(data races)**やメモリモデルとは何なのかを解説します。

## 14.1.1 用語と概念

**マルチスレッド**という用語、一度は聞いた事があるかもしれませんが、そもそもどのような意味なのでしょうか。**プロセス**や**タスク**、**ジョブ**という用語は、Google などで検索するとマルチスレッドに関連して一括りにされて出てくる事もありますが、これらとの違いは一体なんでしょうか。まずはこれらの用語の意味と何故それが必要なのか、その役割を明白にしておきましょう。

### 並列処理
これらの単語を理解するために、まずは**並列処理**とは何なのか、何故必要なのかを述べておきます。例えば HDD上のファイルにアクセスするとしましょう。しかし、第12章でも述べた通り、CPUからこのような外部機器へのアクセスは一般的に低速です。このファイルアクセス中に、他の処理を済ませて置けるのであればユーザーにとっての処理時間は短くなりますね。このように、処理を1つ1つ順次実行していくのではなく、同時に実行する事を並列処理と言います。

### プロセス、タスク、ジョブ

次に、プロセス、タスク、ジョブについて説明します。まず誤解を恐れずに述べてしまえば、**プロセス、タスク、ジョブは、殆どの場合において同じ意味合いである事が多いです**。これらは何かというと、**プログラムの実行単位の事を言います**。ユーザーが OS に対して、例えばエディターとウェブブラウザの起動を指示したとします。もしそれらが1つの実行ファイルから成るのであればそれはまた話は別になってしまいますがそうではなく、それぞれ全く別の実行ファイルから実行されているのであれば、そのそれぞれがプログラムの実行単位であると言えます。
<br>さて、これらの微妙な意味合いの違いを考えて見ましょう。まずは、**プロセス**と**タスク**について考えていきます。**プロセス**は、前述した通りプログラムの実行単位を示す用語ですが、それと同時に**OS 側の視点から見た用語である**とされる事が多いです。例えば Win32 API という、Microsoft 社 による Windows OS の各機能にアクセスするためのインタフェースセットには、**タスク**という用語が一切使われていません。例えば、プログラムの起動のための [`CreateProcess`](https://msdn.microsoft.com/ja-jp/library/windows/desktop/ms682425(v=vs.85).aspx) という関数が同 API には備わっています。続いて、**タスク**は、プロセスという用語の対となるように、**ユーザー側の視点から見た用語である**とされるようです。同 OS の画面下に表示されるプログラムが並ぶバーは、タスクバーと呼ばれていますし、他指定した日時にプログラムを起動するタスクスケジューラという同 OS の付属ツールも**タスク**という用語が使われています。このように Windows においてタスクという用語は単なる**作業**という意味で使われているように受け取れます。有名な企業による用語の使用例を述べましたが、この通り、**明確な定義がない**ため、文脈から判断する必要がある程度の違いしか両者にはないのです。<br>
次にジョブとは何でしょうか。ジョブという用語も実は前述した二つの用語との明確な差異が定義されているわけではありません。ただ傾向として、これも**ユーザー側の視点から見た用語である**と言われる他、複数のプロセスをグループとして扱う場合に、同 API では Job Object を作り、これにプロセスを登録してグループ化する事で、ジョブの状態やジョブに属する全てのプロセスの終了などを可能にします。<br>中々この三つの用語の違いがはっきりしないのであまり気持ちよくないかもしれませんが、元々定義が明確となっていないため、三つの違いに関しては雰囲気だけ理解できれば良いでしょう。また、この三つが**プログラムの実行単位**を示す用語である事が理解できれば良いでしょう。本章では、以降、プロセス、タスク、ジョブをまとめてプロセスと呼称します。


<br><br>最後に、プロセスの特徴について押さえておきましょう。プロセスは、前述した関数などを用いてプロセスを起動する事ができます。このように、プロセスから起動されたプロセスは**子プロセス**と言い、起動した側のプロセスを**親プロセス**と言います。プロセスには、このような親子関係がありますが、それぞれのプロセスごとに別のメモリ領域を利用します。また、命令の実行処理タイミングも異なります。<br>
Windows などのマルチタスク(プロセス) OS は、複数のアプリケーションを同時に実行できますが、それは OS によるサポートがあっての事です。一つのCPU(シングルコア)しかないコンピュータでは、ある一瞬では一つの処理しか実行できません。
これを OS による**マルチプロセス処理**で解決します。**異なるアプリケーション(実行単位、つまりプロセス)が複数の動作を同時に行なっているように見せるために、各処理プロセスを数十ミリ秒といった短い時間で素早く切り替えて、タスク間で一つの CPU を使いまわします**。これを**マルチプロセス(マルチタスク)**また**マルチプロセス処理(マルチタスク処理)**と言います。また、このように処理の流れを一時停止して別の処理に切り替えて実行を行なったり、再開する事を**プリエンプション**と言い、またその過程を**コンテキストスイッチ**と言います。コンテキストスイッチ処理は、オーバーヘッドがあり、処理時間の観点からしても払わなければならないコストとなる事を覚えておきましょう(このようなプロセス切り替えで発生するオーバーヘッドについては後述しています)。

// 画像

尚複数のCPU(マルチコア)を持つコンピューターでは、複数のプロセスを文字通り同時に実行します。以下の図の場合、事実上上記のシングルコアシステムと比較して、半分の量のコンテキストスイッチ切り替えとなります。

// 画像

このようなプリエンプションを行う OS を**プリエンプティブなOS**と言います。またそうでない OS を**ノンプリエンプティブなOS**と言います。**ノンプリエンプティブなOS**では、実行プロセスの切り替え管理を実行プロセス自身に任せますから、そのプロセスが自発的に CPU を解放しなければなりません。よって、解放されるまでの間、1つのプロセス実行中は、他のプロセスの実行が制限される事となります。プリエンプティブなOS では前述した通り、スケジューラが各プロセスをある短い時間ずつ実行します。この短い時間を**タイムスライス**と言います。プロセスがスケジューラの設定したタイムスライスの時間内に CPU を明け渡さなかった場合、OS によるタイマ割り込み(割り込みについては後述しています。)が発生し、OSが別のプロセスを実行させるようにスケジューリングを行い、コンテキストスイッチが発生します。

<br>尚、マルチプロセスとは反対にに一つのプロセスしか実行できない方式を**シングルプロセス(シングルタスク)**また**シングルプロセス処理(シングルプロセス処理)**と言います。


### プロセス切り替えのオーバーヘッドと割り込み
プロセス切り替えにはオーバーヘッドがあるという事を述べました。そして**割り込み**という用語が出てきました。これらについて少し掘り下げておきましょう(しかしあまりにも詳しく触れるとカーネルについての参考書となってしまうため、ここでは少ししか掘り下げません。)。<br>

<br>プロセス切り替えには、その切り替え自体オーバーヘッドがある他に **Translation Lookaside Buffer(TLB)** のミス率の上昇などのコストがあります。TLB は仮想アドレスから物理アドレスへの変換の高速化を測る仕組みです。今日の仮想記憶をサポートするマイクロプロセッサの殆どが、仮想空間と物理空間のマッピングに TLB を利用しています。TLB は連想配列に似たデータ構造である連想メモリで実装されており、CPU がメモリ空間にアクセスする際、検索キーとして仮想アドレスを利用して TLB 上にそのアドレスに対応したエントリがあれば、検索結果として対応する物理アドレスが返るようになっています。これを**TLBヒット**と言います。要求したアドレスがない事を**TLBミス**と言い、TLB のミス率上昇はこれが偶発する確率を上昇させてしまう事を言います。TLBミスである場合、ページテーブル(仮想アドレスと物理アドレスのマッピングを格納したテーブル)を線形探索しなければならなくなってしまいます。この探索を、**ページウォーク**と言います。ページウォークは複数個所のメモリ内容から物理アドレスを計算しなければなりませんので、時間がかかってしまうのです。尚、一度 TLBミスからページウォークによって判明した物理アドレスは、その仮想アドレスと物理アドレスのマッピングが TLB に追加される事となっていますから、アドレスの変化がなければ二度目では必ず TLBヒットします。しかし、コンテキストスイッチを行うとその際に仮想空間の切り替えに伴って TLB エントリの一部が不正となってしまうため、中々無視できるコストではありませんから、この点をよく考える必要があります。<br><br>
次に割り込みについてです。**割り込みとは、コンピュータがその周辺機器から受け取る要求の一種**です。主に、実行中の処理を中断して、強制的に指定された処理を実行させる事を言います。要求には、ハードウェアによるものとソフトウェアによるものがあります。ハードウェア割り込みは、コンピュータの周辺機器などのハードウェアから発生させる割り込みで、ある装置を経由して CPU に信号を送られ OS が実行中の処理を中断して機器の制御に必要な処理を実行します。この装置を**割り込みコントローラ**と言います。次に、ソフトウェア割り込みは、実行中のプログラムが発生させる割り込みの事を言います。これは、例外的な事象が発生した事を OS に伝えて、処理を中断し適切な対応を OS に迫ります。Segmentation fault などがこれに当たります。

### スレッド

**スレッド**は、前述した**プロセス**、**タスク**、**ジョブ**とは、意味としては明確に異なります。**スレッドとはプロセスの中に生成される**
